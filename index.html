<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿæ´»ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ç®¡ç† v22.0 (Stable)</title>
    <style>
        :root {
            --bg-color: #050505;
            --text-main: #ffffff;
            --text-dim: #aaa;
            --panel-bg: rgba(25, 25, 25, 0.98);
            --border-color: #555;
            
            /* ãƒ¢ãƒ¼ãƒ‰ã‚«ãƒ©ãƒ¼å®šç¾© */
            --accent-weekday: #00ff9d;  /* å¹³æ—¥é€šå¸¸ */
            --accent-weekend: #ffae00;  /* ä¼‘æ—¥é€šå¸¸ */
            --accent-rest: #4da6ff;     /* ä¼‘æ¯ãƒ¢ãƒ¼ãƒ‰ */
            --accent-event: #ff66cc;    /* ã‚¤ãƒ™ãƒ³ãƒˆ */
            --accent-emergency: #ff3333; /* ç·Šæ€¥ */
            --accent-overtime: #ff5555;  /* æ®‹æ¥­ */
            
            --prio-high: #ff4444;
            --prio-mid: #ffae00;
            --prio-low: #4da6ff;
            
            --current-accent: var(--accent-weekday);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Helvetica Neue', Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            text-align: center;
            transition: all 0.5s ease;
        }

        /* --- æ®‹æ¥­ãƒ¢ãƒ¼ãƒ‰ (Overtime) --- */
        body.mode-overtime {
            --bg-color: #000;
            --text-main: #ccc;
            --current-accent: var(--accent-overtime);
        }
        body.mode-overtime .action-container { opacity: 0.5; }
        body.mode-overtime .emergency-container { display: none !important; }
        body.mode-overtime .task-banner-container { display: none !important; }
        body.mode-overtime .daily-task-panel { display: none !important; }
        body.mode-overtime .modal-content {
            --text-main: #ffffff;
            --current-accent: var(--accent-weekday);
        }

        /* --- æ™‚è¨ˆã‚¨ãƒªã‚¢ --- */
        .clock-container { margin-bottom: 1vh; cursor: default; width: 100%; }
        .time {
            font-size: 17vw; font-weight: 700; line-height: 0.9;
            letter-spacing: -0.05em; font-variant-numeric: tabular-nums;
            font-family: 'Roboto Mono', monospace;
        }
        .seconds { font-size: 5vw; color: var(--text-dim); margin-left: 10px; }
        .date-area {
            font-size: 4vw; color: var(--text-dim); margin-bottom: 0.5rem;
            display: flex; justify-content: center; gap: 0.8rem; align-items: center; font-weight: bold;
        }
        .mode-badge {
            font-size: 3vw; padding: 0.2em 0.8em;
            border: 1px solid var(--current-accent); color: var(--current-accent);
            border-radius: 99px; font-weight: bold;
            background: rgba(0,0,0,0.3);
        }
        .holiday-name {
            color: var(--accent-event); font-size: 3vw; border: 1px solid var(--accent-event);
            padding: 0.2em 0.8em; border-radius: 99px; display: none;
        }

        /* é€šçŸ¥ãƒ»ã‚¿ã‚¹ã‚¯æ¦‚æ³ */
        .status-line {
            display: flex; flex-direction: column; gap: 5px; align-items: center; min-height: 30px; margin-bottom: 1vh;
        }
        .event-notification {
            font-size: 3.5vw; color: var(--accent-event); font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 102, 204, 0.4);
            animation: pulse 3s infinite; display: none;
        }
        .today-memo {
            margin-top: 5px; font-size: 3.5vw; color: #fff; background: #333;
            padding: 4px 12px; border-radius: 4px; display: inline-block;
        }

        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }

        /* --- å·¦ä¸Šï¼šä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ãƒ‘ãƒãƒ« --- */
        .daily-task-panel {
            position: fixed; top: 15px; left: 15px; z-index: 110;
            display: flex; flex-direction: column; align-items: flex-start;
            max-width: 45%; max-height: 50vh;
        }
        .daily-task-btn {
            background: rgba(40,40,40,0.9); border: 1px solid var(--text-dim);
            color: var(--text-main); padding: 8px 12px; cursor: pointer;
            border-radius: 8px; font-size: 13px; font-weight: bold;
            backdrop-filter: blur(4px); transition: all 0.2s;
            display: flex; align-items: center; gap: 6px; white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .daily-task-btn:hover, .daily-task-btn.active {
            border-color: var(--current-accent); color: var(--current-accent);
        }
        .daily-task-list-wrapper {
            margin-top: 5px; width: 100%; min-width: 200px;
            background: rgba(30,30,30,0.95); border: 1px solid #555;
            border-radius: 6px; padding: 5px; display: none;
            overflow-y: auto; backdrop-filter: blur(10px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .daily-task-list-wrapper.open { display: block; }
        
        .daily-task-row {
            display: flex; align-items: center; gap: 8px; padding: 6px;
            border-bottom: 1px solid #444; font-size: 0.85rem; text-align: left;
        }
        .daily-task-row:last-child { border-bottom: none; }
        .daily-task-row.done { text-decoration: line-through; opacity: 0.5; }
        .daily-task-row .check-circle {
            width: 16px; height: 16px; border: 2px solid #888; border-radius: 50%;
            cursor: pointer; flex-shrink: 0;
        }
        .daily-task-row.done .check-circle { background: var(--current-accent); border-color: var(--current-accent); }
        .daily-task-time { font-family: 'Roboto Mono'; font-size: 0.75rem; color: var(--accent-weekend); margin-right: 2px; }
        .daily-task-text { word-break: break-word; line-height: 1.2; }

        /* --- ç·Šæ€¥ã‚¿ã‚¹ã‚¯è¡¨ç¤ºã‚¨ãƒªã‚¢ --- */
        .emergency-container {
            width: 90%; max-width: 800px; margin: 0 auto 1vh; display: none;
        }
        .emergency-box {
            background: rgba(255, 51, 51, 0.15); border: 1px solid var(--accent-emergency);
            border-radius: 6px; padding: 8px 10px; text-align: left;
            animation: border-pulse 4s infinite;
        }
        .emergency-label {
            color: var(--accent-emergency); font-size: 2.8vw; font-weight: bold; margin-bottom: 4px;
            display: flex; align-items: center; gap: 5px;
        }
        .emergency-list { list-style: none; margin: 0; padding: 0; }
        .emergency-item-display {
            color: #fff; font-size: 3.2vw; font-weight: bold; display: flex; align-items: center; gap: 8px; margin-bottom: 4px;
        }
        .emergency-item-display:last-child { margin-bottom: 0; }
        .btn-emerg-check {
            background: none; border: 1px solid #fff; color: #fff; width: 20px; height: 20px;
            border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 12px; flex-shrink: 0; padding: 0;
        }
        .btn-emerg-check:hover { background: rgba(255,255,255,0.3); }

        @keyframes border-pulse { 0% { box-shadow: 0 0 5px rgba(255,51,51,0.2); } 50% { box-shadow: 0 0 15px rgba(255,51,51,0.5); } 100% { box-shadow: 0 0 5px rgba(255,51,51,0.2); } }

        /* --- é€šå¸¸ã‚¿ã‚¹ã‚¯è¡¨ç¤º (ãƒãƒŠãƒ¼å½¢å¼) --- */
        .task-banner-container {
            width: 90%; max-width: 800px; margin: 0 auto 1.5vh; display: none;
            justify-content: center; 
        }
        .task-banner {
            width: 100%; 
            background: rgba(255, 174, 0, 0.1); border: 1px solid var(--accent-weekend);
            border-radius: 6px; padding: 6px 12px; 
            display: flex; align-items: center; justify-content: space-between; gap: 10px;
        }
        .task-banner-content {
            flex-grow: 1; text-align: left; display: flex; flex-direction: column;
        }
        .task-banner-label { 
            color: var(--accent-weekend); font-size: 2.2vw; font-weight: bold; margin-bottom: 2px;
        }
        .task-banner-title { 
            color: #fff; font-size: 3.5vw; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .task-banner-time {
            color: #ccc; font-size: 2.5vw; font-family: 'Roboto Mono'; margin-left: 5px;
        }
        .task-banner-btn {
            background: var(--accent-weekend); color: #000; border: none; padding: 4px 10px;
            font-weight: bold; border-radius: 4px; font-size: 2.5vw; cursor: pointer; flex-shrink: 0;
        }

        /* --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º --- */
        .action-container { width: 90%; max-width: 800px; margin: 0 auto; }
        .label { font-size: 3.5vw; color: var(--text-dim); margin-bottom: 0.5rem; }
        .current-action {
            font-size: 7vw; color: var(--current-accent); font-weight: bold;
            margin-bottom: 3vh; line-height: 1.2;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.1); min-height: 1.2em;
        }
        .progress-container {
            width: 100%; height: 8px; background-color: #333;
            border-radius: 4px; margin-bottom: 2vh; overflow: hidden;
        }
        .progress-bar {
            height: 100%; background-color: var(--current-accent); width: 0%;
            transition: width 1s linear, background-color 0.5s ease;
        }
        .time-remaining { text-align: right; font-size: 3.5vw; color: var(--text-dim); margin-bottom: 3vh; }
        
        .next-action {
            font-size: 4vw; color: var(--text-dim); border-top: 1px solid var(--border-color);
            padding-top: 2vh; display: flex; justify-content: center; align-items: baseline; gap: 1rem;
        }
        .next-time { font-family: 'Roboto Mono', monospace; font-weight: bold; }

        /* --- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« --- */
        .controls {
            position: fixed; top: 15px; right: 15px; display: flex; gap: 8px; z-index: 100; flex-wrap: wrap; justify-content: flex-end; width: 50%; pointer-events: none;
        }
        .controls > * { pointer-events: auto; }
        
        .btn {
            background: rgba(40,40,40,0.9); border: 1px solid var(--text-dim);
            color: var(--text-main); padding: 8px 12px; cursor: pointer;
            border-radius: 8px; font-size: 13px; font-weight: bold;
            backdrop-filter: blur(4px); transition: all 0.2s;
            display: flex; align-items: center; gap: 4px; white-space: nowrap;
        }
        .btn:hover { border-color: var(--current-accent); color: var(--current-accent); }
        .btn.active {
            background: rgba(255,255,255,0.15); border-color: var(--current-accent);
            color: var(--current-accent); box-shadow: 0 0 10px var(--current-accent);
        }
        #btnOvertime.active {
            background: rgba(255, 85, 85, 0.2); border-color: var(--accent-overtime); color: var(--accent-overtime);
            box-shadow: 0 0 15px rgba(255, 85, 85, 0.4);
        }

        /* --- ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 200;
            justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .modal.open { display: flex; }
        .modal-content {
            background: var(--panel-bg); border: 1px solid var(--border-color);
            width: 95%; max-width: 600px; max-height: 90vh;
            padding: 20px; border-radius: 12px; display: flex; flex-direction: column;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            color: #ffffff !important;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;
        }
        .modal-title { font-weight: bold; font-size: 1.1rem; color: #fff; }

        /* ã‚¿ãƒ– */
        .tab-container { display: flex; gap: 5px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn {
            flex: 1; min-width: 80px; padding: 10px; font-size: 13px;
            background: #333; border: 1px solid #555; color: #ccc; border-radius: 4px; cursor: pointer;
        }
        .tab-btn.active { background: #444; color: #fff; border-color: var(--current-accent); font-weight: bold; }

        /* ãƒªã‚¹ãƒˆç³» */
        .list-container { overflow-y: auto; flex-grow: 1; margin-bottom: 10px; padding-right: 5px; }
        .list-item {
            display: grid; gap: 8px; margin-bottom: 8px; align-items: center;
            background: #222; padding: 10px; border-radius: 6px; border: 1px solid #444;
        }
        .schedule-item { grid-template-columns: 60px 60px 1fr 30px; }
        /* ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆï¼šã‚«ã‚¹ã‚¿ãƒ ã¯å‰Šé™¤ãƒœã‚¿ãƒ³ã‚ã‚Š */
        .event-item-custom { grid-template-columns: 80px 1fr 30px; border-left: 3px solid var(--accent-event); }
        
        /* ãƒ•ã‚©ãƒ¼ãƒ å…±é€šè¨­å®š */
        ::placeholder { color: #aaa; opacity: 0.8; }
        
        /* selectè¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ«ä¿®æ­£ (é»’ããªã‚‹ãƒã‚°å¯¾å¿œ) */
        select {
            color: #ffffff !important;
            background-color: #444 !important;
            -webkit-appearance: none;
            appearance: none;
        }
        /* optionè¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        option {
            background-color: #333 !important;
            color: #ffffff !important;
        }

        .list-item input, .list-item select, textarea, .task-input-area input, .task-input-area select, .task-date-input, .emergency-input {
            background: #444 !important;
            border: 1px solid #777;
            color: #ffffff !important; /* å¼·åˆ¶çš„ã«ç™½æ–‡å­— */
            padding: 8px; border-radius: 4px; text-align: center; font-size: 14px; 
            width: 100%; box-sizing: border-box;
        }
        
        .list-item input:focus, textarea:focus, select:focus, .task-date-input:focus, .emergency-input:focus {
            border-color: var(--current-accent); outline: none; background: #555 !important;
            color: #ffffff !important;
        }
        .list-item input.inp-name { text-align: left; flex-grow: 1; }
        .btn-delete { color: #ff5555; border: none; background: none; font-size: 1.3rem; cursor: pointer; padding: 0 5px;}

        /* ã‚¿ã‚¹ã‚¯ã‚¢ã‚¤ãƒ†ãƒ  */
        .task-item {
            display: flex; gap: 10px; align-items: center; background: #2a2a2a; padding: 12px;
            border-radius: 6px; margin-bottom: 8px; border-left: 5px solid #555;
            border-bottom: 1px solid #333;
        }
        .task-item.prio-high { border-left-color: var(--prio-high); }
        .task-item.prio-mid { border-left-color: var(--prio-mid); }
        .task-item.prio-low { border-left-color: var(--prio-low); }
        .task-item.done { opacity: 0.6; background: #1a1a1a; border-left-color: #444; }
        .task-item.done .task-text { text-decoration: line-through; color: #777; }

        /* ç·Šæ€¥ã‚¿ã‚¹ã‚¯è¨­å®šã‚¨ãƒªã‚¢ */
        .emergency-section {
            border: 1px solid #444; background: #222; padding: 10px; border-radius: 6px; margin-bottom: 15px;
        }
        .emergency-item-edit { display: flex; gap: 5px; margin-bottom: 5px; }

        .btn-check { 
            color: #888; border: 2px solid #666; background: none; width: 26px; height: 26px; flex-shrink: 0;
            border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .btn-check.checked { background: var(--current-accent); border-color: var(--current-accent); color: #000; font-weight: bold;}

        .task-content { flex-grow: 1; text-align: left; overflow: hidden;}
        .task-text { font-weight: bold; font-size: 1rem; margin-bottom: 4px; }
        .task-meta { font-size: 0.8rem; color: #aaa; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;}
        
        .task-date-input { width: auto; padding: 2px 5px; font-size: 0.8rem; border-color: #555; background: #222; color: #ddd; max-width: 110px; }

        .prio-select-wrapper { position: relative; }
        .prio-select {
            appearance: none; -webkit-appearance: none;
            padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; cursor: pointer;
            border: 1px solid rgba(255,255,255,0.2); text-align: center;
            width: auto; display: inline-block;
        }
        .prio-select.high { background: rgba(255, 68, 68, 0.2); color: #ff8888; border-color: var(--prio-high); }
        .prio-select.mid { background: rgba(255, 174, 0, 0.2); color: #ffcc66; border-color: var(--prio-mid); }
        .prio-select.low { background: rgba(77, 166, 255, 0.2); color: #88ccff; border-color: var(--prio-low); }

        .date-shortcuts { display: flex; gap: 5px; margin-bottom: 5px; }
        .date-chip { 
            font-size: 0.75rem; padding: 4px 8px; background: #444; color: #ddd; border-radius: 4px; cursor: pointer; border: 1px solid #555;
        }
        .date-chip:hover { background: #555; color: #fff; }

        /* é‡è¤‡è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .conflict-warning {
            color: #ffaa00; font-size: 0.8rem; margin-bottom: 5px; display: none; font-weight: bold; text-align: left;
        }

        .completed-section { margin-top: 15px; border-top: 1px solid #444; padding-top: 10px; }
        .toggle-completed {
            width: 100%; background: #222; border: 1px solid #444; color: #888; padding: 8px;
            font-size: 0.9rem; cursor: pointer; border-radius: 4px; margin-bottom: 10px;
        }
        .toggle-completed:hover { background: #333; color: #fff; }
        .completed-list { display: none; }
        .completed-list.show { display: block; }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
        .calendar-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 15px;
        }
        .cal-header { font-weight: bold; color: #888; font-size: 0.8rem; padding: 5px 0; }
        .cal-day {
            aspect-ratio: 1; display: flex; flex-direction: column; justify-content: flex-start;
            align-items: center; background: #222; border-radius: 4px; cursor: pointer;
            padding: 4px; font-size: 0.9rem; position: relative; overflow: hidden;
        }
        .cal-day:hover { background: #333; }
        .cal-day.today { border: 1px solid #fff; }
        .cal-day.is-holiday { color: #ffae00; background: rgba(255, 174, 0, 0.15); }
        .cal-day.is-event { color: #ff66cc; }
        .cal-day.has-note .cal-note-dot { display: block; }
        
        .cal-task-bar { width: 80%; height: 4px; margin-top: 2px; border-radius: 2px; background: #555; }
        .cal-task-bar.high { background: var(--prio-high); }
        .cal-task-bar.mid { background: var(--prio-mid); }
        .cal-task-bar.low { background: var(--prio-low); }

        .cal-note-dot { width: 4px; height: 4px; background: #fff; border-radius: 50%; margin-top: 2px; display: none; }
        .cal-nav { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; font-weight: bold; }

        /* æ—¥åˆ¥ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .day-task-list { margin-top: 15px; border-top: 1px solid #444; padding-top: 10px; }
        .day-task-item {
            display: flex; justify-content: space-between; align-items: center;
            background: #222; padding: 8px; border-radius: 4px; margin-bottom: 5px; border-left: 3px solid #555; font-size: 0.9rem;
        }
        .day-task-item.high { border-left-color: var(--prio-high); }
        .day-task-item.mid { border-left-color: var(--prio-mid); }
        .day-task-item.low { border-left-color: var(--prio-low); }
        .day-task-item.done { text-decoration: line-through; color: #666; border-left-color: #444; }

        /* é€£æºãƒªãƒ³ã‚¯ */
        .link-area { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; border-top: 1px solid #444; padding-top: 10px; }
        .link-btn {
            background: #222; border: 1px solid #555; color: #ccc; padding: 10px;
            font-size: 12px; text-decoration: none; border-radius: 4px; flex: 1; min-width: 80px; display: block;
        }
        .link-btn:hover { background: #333; color: #fff; border-color: #777; }

        /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
        @media (max-width: 600px) {
            .time { font-size: 20vw; }
            .list-item { font-size: 12px; padding: 8px; }
            .event-item-custom { grid-template-columns: 60px 1fr 30px; }
            .schedule-item { grid-template-columns: 50px 50px 1fr 25px; }
            .controls { top: 10px; right: 10px; gap: 6px; }
            .btn { font-size: 11px; padding: 6px 10px; }
            .task-input-area { padding-bottom: 20px; } 
            .emergency-item-display { font-size: 4.5vw; }
            .task-banner-title { font-size: 4vw; }
            
            .daily-task-panel { max-width: 60%; }
        }
    </style>
</head>
<body>

    <!-- å·¦ä¸Šï¼šä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ãƒ‘ãƒãƒ« -->
    <div class="daily-task-panel" id="dailyTaskPanel">
        <button class="daily-task-btn" onclick="toggleDailyTaskPanel()">
            ğŸ“‹ ä»Šæ—¥: <span id="dailyTaskCount">0</span>
        </button>
        <div class="daily-task-list-wrapper" id="dailyTaskListWrapper">
            <div id="dailyTaskListInner"></div>
        </div>
    </div>

    <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
    <div class="controls">
        <button class="btn" id="btnRest" onclick="toggleRestMode()">
            <span>ğŸ›Œ</span> <span id="restText">ä¼‘æ¯</span>
        </button>
        <button class="btn" id="btnOvertime" onclick="toggleOvertimeMode()">
            <span>âš ï¸</span> æ®‹æ¥­
        </button>
        <button class="btn" onclick="openTaskManager()">
            <span>â˜‘ï¸</span> ã‚¿ã‚¹ã‚¯
        </button>
        <!-- ã‚¤ãƒ™ãƒ³ãƒˆé–²è¦§ãƒ»ç·¨é›† (ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰åŒ–) -->
        <button class="btn" onclick="openEventManager()">
            <span>ğŸ‰</span>
        </button>
        <button class="btn" onclick="openCalendar()">
            <span>ğŸ—“ï¸</span>
        </button>
        <button class="btn" onclick="openConfig()">
            <span>ğŸ”§</span>
        </button>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
    <div class="clock-container">
        <div class="date-area">
            <span id="dateDisplay">--/-- (-)</span>
            <span class="mode-badge" id="modeBadge">---</span>
            <span class="holiday-name" id="holidayNameDisplay"></span>
        </div>
        
        <div class="status-line">
            <div class="event-notification" id="eventNotification"></div>
            <div class="today-memo" id="todayMemoDisplay" style="display:none;"></div>
        </div>

        <div class="time">
            <span id="timeDisplay">00:00</span><span class="seconds" id="secDisplay">00</span>
        </div>
    </div>

    <!-- ç·Šæ€¥ã‚¿ã‚¹ã‚¯è¡¨ç¤º (ãƒ¡ã‚¤ãƒ³) -->
    <div class="emergency-container" id="emergencyDisplay">
        <div class="emergency-box">
            <div class="emergency-label">ğŸš¨ EMERGENCY (é€£çµ¡å¾…ã¡ãƒ»ç·Šæ€¥)</div>
            <ul class="emergency-list" id="emergencyListDisplay"></ul>
        </div>
    </div>

    <!-- ã‚¿ã‚¹ã‚¯è¡¨ç¤º (ãƒãƒŠãƒ¼) -->
    <div class="task-banner-container" id="interruptTaskDisplay">
        <div class="task-banner">
            <div class="task-banner-content">
                <span class="task-banner-label">âš¡ CURRENT TASK</span>
                <div style="display:flex; align-items:baseline;">
                    <span class="task-banner-title" id="interruptTaskTitle"></span>
                    <span class="task-banner-time" id="interruptTaskTime"></span>
                </div>
            </div>
            <button class="task-banner-btn" onclick="completeInterruptTask()">å®Œäº†</button>
        </div>
    </div>

    <div class="action-container">
        <div class="label">CURRENT MISSION</div>
        <div class="current-action" id="actionDisplay">---</div>
        
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="time-remaining" id="timeRemaining">æ®‹ã‚Š --åˆ†</div>

        <div class="next-action">
            <span class="next-label">NEXT</span>
            <span id="nextTime" class="next-time">--:--</span>
            <span id="nextActionDisplay">---</span>
        </div>
    </div>

    <!-- ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ã‚¿ã‚¹ã‚¯ç®¡ç†</div>
                <button class="btn" onclick="closeTaskManager()">âœ•</button>
            </div>
            
            <div class="emergency-section">
                <div style="font-weight:bold; color:var(--accent-emergency); margin-bottom:5px; font-size:0.9rem;">ğŸš¨ ç·Šæ€¥ãƒ»é€£çµ¡å¾…ã¡</div>
                <div id="emergencyEditList"></div>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <input type="text" id="newEmergencyInput" class="emergency-input" placeholder="ä¾‹: å®¶é›»é€£çµ¡å¾…ã¡" style="text-align:left;">
                    <button class="btn" style="border-color:var(--accent-emergency); color:var(--accent-emergency);" onclick="addEmergency()">è¿½åŠ </button>
                </div>
            </div>

            <div class="list-container" id="taskList" style="max-height: 35vh;"></div>

            <div class="completed-section">
                <button class="toggle-completed" onclick="toggleCompletedList()">
                    ğŸ”½ å®Œäº†æ¸ˆã¿ã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤º (<span id="completedCount">0</span>)
                </button>
                <div class="completed-list" id="completedList"></div>
            </div>
            
            <!-- ã‚¹ãƒ­ãƒƒãƒˆé¸æŠå¼UI (ã‚ªãƒ¼ãƒ€ãƒ¼å¯¾å¿œç®‡æ‰€) -->
            <div class="task-input-area" style="border-top:1px solid #555; padding-top:15px; margin-top:10px;">
                <div class="date-shortcuts">
                    <span class="date-chip" onclick="setInputDate('today')">ä»Šæ—¥</span>
                    <span class="date-chip" onclick="setInputDate('tomorrow')">æ˜æ—¥</span>
                    <span class="date-chip" onclick="setInputDate('')">æœªå®š</span>
                </div>
                
                <div style="margin-bottom:8px;">
                    <select id="taskSlotSelect" class="list-item select" onchange="checkBooking()">
                        <option value="">ã‚¹ãƒ­ãƒƒãƒˆã‚’é¸æŠ (ä»»æ„)</option>
                        <option value="08:30|15">ğŸŒ… æœé£Ÿå‰ (08:30~ 15åˆ†)</option>
                        <option value="05:20|50">ğŸƒ æœæ´» (05:20~ 50åˆ†)</option>
                        <option value="12:30|30">ğŸ½ï¸ æ˜¼ä¼‘æ†© (12:30~ 30åˆ†)</option>
                        <option value="18:30|15">ğŸ¢ çµ‚æ¥­å¾Œ (18:30~ 15åˆ†)</option>
                        <option value="19:00|15">ğŸ  å¸°å®…å¾Œ (19:00~ 15åˆ†)</option>
                    </select>
                    <div id="bookingWarning" class="conflict-warning">âš ï¸ ã“ã®æ ã¯æ—¢ã«åŸ‹ã¾ã£ã¦ã„ã¾ã™ï¼</div>
                </div>
                
                <!-- æ‰‹å‹•æ™‚é–“è¨­å®š (ã‚¹ãƒ­ãƒƒãƒˆãŒä½¿ãˆãªã„å ´åˆã®äºˆå‚™) -->
                <div style="display:none;">
                    <select id="newTaskStartTime" class="list-item select"></select>
                    <input type="number" id="newTaskDuration" value="15" placeholder="åˆ†">
                </div>
                
                <div style="display:grid; grid-template-columns: 1fr 110px 70px; gap:8px; margin-bottom:10px;">
                    <input type="text" id="newTaskName" class="list-item input" placeholder="ã‚¿ã‚¹ã‚¯å†…å®¹" style="text-align:left;">
                    <input type="date" id="newTaskDate" class="list-item input" onchange="checkBooking()">
                    <select id="newTaskPrio" class="list-item select">
                        <option value="high">é«˜</option>
                        <option value="mid" selected>ä¸­</option>
                        <option value="low">ä½</option>
                    </select>
                </div>
                <button class="btn" style="width:100%; justify-content:center; border-color:var(--current-accent); color:var(--current-accent); background:#333; padding:12px;" onclick="addTask()">ï¼‹ ã‚¿ã‚¹ã‚¯è¿½åŠ </button>
            </div>
        </div>
    </div>

    <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã€ã‚¤ãƒ™ãƒ³ãƒˆã€æ—¥åˆ¥è¨­å®šã€è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="calModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div>
                <button class="btn" onclick="closeCalendar()">âœ•</button>
            </div>
            <div class="cal-nav">
                <button class="btn" onclick="changeMonth(-1)">â—€</button>
                <span id="calMonthLabel"></span>
                <button class="btn" onclick="changeMonth(1)">â–¶</button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
            <div class="link-area">
                <a href="#" class="link-btn" onclick="alert('URLæœªè¨­å®š')">ğŸ“… Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</a>
                <a href="#" class="link-btn" onclick="alert('URLæœªè¨­å®š')">ğŸ“ Notion / ãƒ¡ãƒ¢</a>
                <a href="#" class="link-btn" onclick="alert('URLæœªè¨­å®š')">ğŸ’° å®¶è¨ˆç°¿ / ã‚¹ãƒ—ã‚·</a>
            </div>
        </div>
    </div>

    <!-- ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« (ä¿®æ­£: å…¥åŠ›å¾©æ´»ã€ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰è¡¨ç¤º) -->
    <div class="modal" id="eventModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">è¨˜å¿µæ—¥è¨­å®š (å€‹äººã‚¤ãƒ™ãƒ³ãƒˆ)</div>
                <button class="btn" onclick="closeEventManager()">âœ•</button>
            </div>
            
            <div class="list-container" id="eventList"></div>
            
            <!-- ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  (ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³å¼) -->
            <div style="display:flex; gap:5px; margin-top:10px; border-top:1px solid #444; padding-top:10px;">
                <select id="newEventMonth" class="list-item select" style="width:60px;">
                    <!-- JSã§ç”Ÿæˆ -->
                </select>æœˆ
                <select id="newEventDay" class="list-item select" style="width:60px;">
                    <!-- JSã§ç”Ÿæˆ -->
                </select>æ—¥
                <input type="text" id="newEventName" class="list-item input" placeholder="è¨˜å¿µæ—¥å" style="flex:1; text-align:left;">
                <button class="btn" style="border-color:var(--accent-event); color:var(--accent-event);" onclick="addCustomEvent()">ï¼‹ è¿½åŠ </button>
            </div>
        </div>
    </div>

    <div class="modal" id="dayConfigModal">
        <div class="modal-content" style="max-height: 500px;">
            <div class="modal-header">
                <div class="modal-title" id="dayConfigTitle">è¨­å®š</div>
                <button class="btn" onclick="closeDayConfig()">âœ•</button>
            </div>
            <div style="display:flex; flex-direction:column; gap:15px; text-align:left; overflow-y:auto;">
                <div id="dayHolidayInfo" style="color:var(--accent-event); font-weight:bold; display:none;"></div>
                <div id="dayTaskSection" style="display:none;">
                    <label style="color:#aaa; font-size:0.9rem;">â˜‘ï¸ ã“ã®æ—¥ã®ã‚¿ã‚¹ã‚¯</label>
                    <div id="dayTaskList" class="day-task-list"></div>
                </div>
                <div>
                    <label style="color:#aaa; font-size:0.9rem;">ğŸ“ ãƒ¡ãƒ¢</label>
                    <textarea id="dayMemoInput" style="width:100%; height:60px; margin-top:5px; resize:none;"></textarea>
                </div>
                <div>
                    <label style="color:#aaa; font-size:0.9rem;">âš™ï¸ ãƒ¢ãƒ¼ãƒ‰æŒ‡å®š</label>
                    <select id="dayModeSelect" style="width:100%; margin-top:5px;">
                        <option value="">è‡ªå‹•åˆ¤å®š (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)</option>
                        <option value="weekday_normal">å¹³æ—¥ (é€šå¸¸)</option>
                        <option value="weekday_rest">å¹³æ—¥ (ä¼‘æ¯)</option>
                        <option value="weekend_normal">ä¼‘æ—¥ (é€šå¸¸)</option>
                        <option value="weekend_rest">ä¼‘æ—¥ (ä¼‘æ¯)</option>
                    </select>
                </div>
                <button class="btn" style="border-color:var(--current-accent); color:var(--current-accent); justify-content:center;" onclick="saveDayConfig()">è¨­å®šä¿å­˜</button>
            </div>
        </div>
    </div>

    <div class="modal" id="configModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">è¨ˆç”»èª¿æ•´ (å…¨ãƒ¢ãƒ¼ãƒ‰)</div>
                <button class="btn" onclick="closeConfig()">âœ•</button>
            </div>
            <div class="tab-container" id="editorTabs">
                <button class="tab-btn" onclick="switchEditorTab('weekday_normal')" id="tab_weekday_normal">å¹³æ—¥(é€šå¸¸)</button>
                <button class="tab-btn" onclick="switchEditorTab('weekday_rest')" id="tab_weekday_rest">å¹³æ—¥(ä¼‘æ¯)</button>
                <button class="tab-btn" onclick="switchEditorTab('weekend_normal')" id="tab_weekend_normal">ä¼‘æ—¥(é€šå¸¸)</button>
                <button class="tab-btn" onclick="switchEditorTab('weekend_rest')" id="tab_weekend_rest">ä¼‘æ—¥(ä¼‘æ¯)</button>
            </div>
            <div class="list-container" id="scheduleList"></div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn" style="flex:1" onclick="addScheduleRow()">ï¼‹ è¿½åŠ </button>
                <button class="btn" style="flex:1; border-color:var(--current-accent); color:var(--current-accent);" onclick="saveConfig()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * GLOBAL VARIABLES
         */
        const STORAGE_KEY = 'routine_dashboard_v22_fix'; // ä¿å­˜ã‚­ãƒ¼ã‚’åˆ·æ–°ã—ä¸æ•´åˆã‚’è§£æ¶ˆ

        let appData = {
            schedules: {},
            calendarEvents: {}, 
            customEvents: [], 
            tasks: [], 
            emergencyList: [],
            isRestMode: false,
            isOvertimeMode: false,
            showCompleted: false
        };

        let editingModeKey = 'weekday_normal';
        let viewingMonth = new Date();
        let cachedHolidays = {};
        let currentInterruptTaskId = null;
        let configuringDateKey = null;

        // --- å›ºå®šã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ (ç·¨é›†ä¸å¯ãƒ»å­£ç¯€è¡Œäº‹) ---
        const FIXED_EVENTS = [ 
            { date:"*-01-01", name:"å…ƒæ—¦", type:"event" },
            { date:"*-02-03", name:"ç¯€åˆ†", type:"event" },
            { date:"*-02-14", name:"ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³", type:"event" },
            { date:"*-03-03", name:"ã²ãªç¥­ã‚Š", type:"event" },
            { date:"*-03-14", name:"ãƒ›ãƒ¯ã‚¤ãƒˆãƒ‡ãƒ¼", type:"event" },
            { date:"*-07-07", name:"ä¸ƒå¤•", type:"event" },
            { date:"*-08-15", name:"çµ‚æˆ¦è¨˜å¿µæ—¥", type:"event" },
            { date:"*-10-31", name:"ãƒãƒ­ã‚¦ã‚£ãƒ³", type:"event" },
            { date:"*-12-24", name:"ã‚¯ãƒªã‚¹ãƒã‚¹ã‚¤ãƒ–", type:"event" },
            { date:"*-12-25", name:"ã‚¯ãƒªã‚¹ãƒã‚¹", type:"event" },
            { date:"*-12-31", name:"å¤§æ™¦æ—¥", type:"event" }
        ];

        // --- ç¥æ—¥è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
        const JapanHolidays = {
            getHolidays: function(year) {
                const holidays = {}; 
                const fixed = { "01-01":"å…ƒæ—¥", "02-11":"å»ºå›½è¨˜å¿µã®æ—¥", "02-23":"å¤©çš‡èª•ç”Ÿæ—¥", "04-29":"æ˜­å’Œã®æ—¥", "05-03":"æ†²æ³•è¨˜å¿µæ—¥", "05-04":"ã¿ã©ã‚Šã®æ—¥", "05-05":"ã“ã©ã‚‚ã®æ—¥", "08-11":"å±±ã®æ—¥", "11-03":"æ–‡åŒ–ã®æ—¥", "11-23":"å‹¤åŠ´æ„Ÿè¬ã®æ—¥" };
                for(let k in fixed) holidays[`${year}-${k}`] = fixed[k];
                const happy = [{m:1,w:2,n:"æˆäººã®æ—¥"}, {m:7,w:3,n:"æµ·ã®æ—¥"}, {m:9,w:3,n:"æ•¬è€ã®æ—¥"}, {m:10,w:2,n:"ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥"}];
                happy.forEach(h => { holidays[this.fmt(this.getNthMonday(year,h.m,h.w))] = h.n; });
                const shunbun = Math.floor(20.8431 + 0.242194 * (year - 1980) - Math.floor((year - 1980) / 4));
                const shubun = Math.floor(23.2488 + 0.242194 * (year - 1980) - Math.floor((year - 1980) / 4));
                holidays[`${year}-03-${shunbun}`] = "æ˜¥åˆ†ã®æ—¥"; holidays[`${year}-09-${shubun}`] = "ç§‹åˆ†ã®æ—¥";
                const sorted = Object.keys(holidays).sort();
                const substitutes = {};
                sorted.forEach(dStr => {
                    const d = new Date(dStr);
                    if(d.getDay()===0) {
                        let next = new Date(d); next.setDate(next.getDate()+1);
                        while(holidays[this.fmt(next)] || substitutes[this.fmt(next)]) next.setDate(next.getDate()+1);
                        substitutes[this.fmt(next)] = "æŒ¯æ›¿ä¼‘æ—¥";
                    }
                });
                return {...holidays, ...substitutes};
            },
            getNthMonday: function(y,m,n) {
                const first = new Date(y,m-1,1);
                const diff = (first.getDay()===1) ? 0 : (8-first.getDay())%7;
                return new Date(y,m-1, 1+diff+(n-1)*7);
            },
            fmt: function(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
        };

        // --- ãƒ‡ãƒ¼ã‚¿å®šç¾© ---
        const defaultSchedules = {
            weekday_normal: [ { start:"00:00", end:"05:00", name:"ğŸ›Œ ç¡çœ " }, { start:"05:00", end:"06:30", name:"ğŸƒ æœãƒ«ãƒ¼ãƒ†ã‚£ãƒ³" }, { start:"06:30", end:"08:30", name:"âœ’ï¸ å‰µä½œ" }, { start:"08:30", end:"09:30", name:"ğŸš¿ æœé£Ÿãƒ»é€šå‹¤" }, { start:"09:30", end:"18:30", name:"ğŸ¢ æœ¬æ¥­" }, { start:"18:30", end:"21:30", name:"ğŸ  å¤œãƒ«ãƒ¼ãƒ†ã‚£ãƒ³" }, { start:"21:30", end:"24:00", name:"ğŸ›Œ å°±å¯" } ],
            weekday_rest: [ { start:"00:00", end:"05:00", name:"ğŸ›Œ ç¡çœ " }, { start:"05:00", end:"09:00", name:"ğŸ›Œ å›å¾©" }, { start:"09:00", end:"18:30", name:"ğŸ¢ æœ¬æ¥­(çœã‚¨ãƒ)" }, { start:"18:30", end:"21:30", name:"ğŸ  ä¼‘æ¯" }, { start:"21:30", end:"24:00", name:"ğŸ›Œ å°±å¯" } ],
            weekend_normal: [ { start:"00:00", end:"05:00", name:"ğŸ›Œ ç¡çœ " }, { start:"05:00", end:"06:30", name:"ğŸƒ æœãƒ«ãƒ¼ãƒ†ã‚£ãƒ³" }, { start:"06:30", end:"09:00", name:"âœ’ï¸ å‰µä½œ/å®¶äº‹" }, { start:"09:00", end:"13:30", name:"â˜• å¤–å‡º/ã‚«ãƒ•ã‚§" }, { start:"13:30", end:"17:30", name:"âœ’ï¸ å‰µä½œ" }, { start:"17:30", end:"21:30", name:"ğŸ® è‡ªç”±" }, { start:"21:30", end:"24:00", name:"ğŸ›Œ å°±å¯" } ],
            weekend_rest: [ { start:"00:00", end:"12:00", name:"ğŸ›Œ çˆ†ç¡" }, { start:"12:00", end:"21:30", name:"ğŸ  ç™‚é¤Š" }, { start:"21:30", end:"24:00", name:"ğŸ›Œ å°±å¯" } ]
        };
        
        const MODE_INFO = { 'weekday_normal':{name:'å¹³æ—¥(é€šå¸¸)',color:'#00ff9d'}, 'weekday_rest':{name:'å¹³æ—¥(ä¼‘æ¯)',color:'#4da6ff'}, 'weekend_normal':{name:'ä¼‘æ—¥(é€šå¸¸)',color:'#ffae00'}, 'weekend_rest':{name:'ä¼‘æ—¥(ä¼‘æ¯)',color:'#4da6ff'} };

        // --- ä¿å­˜ãƒ»èª­è¾¼ ---
        function loadData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const loaded = JSON.parse(saved);
                appData = { ...appData, ...loaded };
            } else {
                appData.schedules = JSON.parse(JSON.stringify(defaultSchedules));
                // customEventsã¯ç©ºã§åˆæœŸåŒ–
            }
            // ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§è£œæ­£
            if(!appData.tasks) appData.tasks = [];
            if(!appData.emergencyList) appData.emergencyList = [];
            if(!appData.customEvents) appData.customEvents = [];
            if(!appData.schedules) appData.schedules = JSON.parse(JSON.stringify(defaultSchedules));
            
            initTimeOptions();
            initEventSelects();
        }
        function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); }

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        function getMinutes(t) { return t ? t.split(':').reduce((h, m) => h * 60 + +m, 0) : 0; }
        function getYYYYMMDD(date) { return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`; }
        function getMMDD(date) { return `*-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`; }

        function getHolidayName(date) {
            const y = date.getFullYear();
            if (!cachedHolidays[y]) cachedHolidays[y] = JapanHolidays.getHolidays(y);
            return cachedHolidays[y][getYYYYMMDD(date)] || null;
        }

        function checkEventStatus(date) {
            const holiday = getHolidayName(date);
            if (holiday) return { name: holiday, type: 'holiday' };
            const ymd = getYYYYMMDD(date);
            const md = getMMDD(date);
            // å›ºå®šã‚¤ãƒ™ãƒ³ãƒˆã¨ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã®ä¸¡æ–¹ã‚’ãƒã‚§ãƒƒã‚¯
            const fixed = FIXED_EVENTS.find(e => e.date === ymd || e.date === md);
            if(fixed) return fixed;
            return appData.customEvents.find(e => e.date === ymd || e.date === md) || null;
        }

        function determineCurrentMode() {
            if(appData.isOvertimeMode) return 'weekday_rest';
            const now = new Date();
            const dateKey = getYYYYMMDD(now);
            if (appData.calendarEvents[dateKey] && appData.calendarEvents[dateKey].mode) return appData.calendarEvents[dateKey].mode;
            const evt = checkEventStatus(now);
            const isHoliday = (evt && evt.type === 'holiday');
            const day = now.getDay();
            const base = (day === 0 || day === 6 || isHoliday) ? 'weekend' : 'weekday';
            return appData.isRestMode ? `${base}_rest` : `${base}_normal`;
        }

        // --- é€šçŸ¥ï¼†è¡¨ç¤ºæ›´æ–° ---
        function updateDisplay() {
            const now = new Date();
            const daysJP = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
            const todayKey = getYYYYMMDD(now);
            const curM = now.getHours() * 60 + now.getMinutes();
            
            document.getElementById('timeDisplay').textContent = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            document.getElementById('secDisplay').textContent = String(now.getSeconds()).padStart(2,'0');
            document.getElementById('dateDisplay').textContent = `${now.getMonth()+1}/${now.getDate()} (${daysJP[now.getDay()]})`;

            // ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯æ›´æ–°
            updateDailyTaskPanel(todayKey);

            if(appData.isOvertimeMode) {
                document.body.classList.add('mode-overtime');
                document.getElementById('modeBadge').textContent = "âš ï¸ æ®‹æ¥­";
                document.getElementById('btnOvertime').classList.add('active');
                document.getElementById('actionDisplay').textContent = "å¸°å®…ãƒ»å³å¯";
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('timeRemaining').textContent = "æ€è€ƒåœæ­¢ã—ã¦å®Ÿè¡Œã›ã‚ˆ";
                document.getElementById('nextActionDisplay').textContent = "21:30 å°±å¯";
                document.getElementById('nextTime').textContent = "--:--";
                document.getElementById('emergencyDisplay').style.display = 'none';
                document.getElementById('interruptTaskDisplay').style.display = 'none';
                return;
            } else {
                document.body.classList.remove('mode-overtime');
                document.getElementById('btnOvertime').classList.remove('active');
            }

            const holidayName = getHolidayName(now);
            const holEl = document.getElementById('holidayNameDisplay');
            if(holidayName) { holEl.textContent = `ãŠ—ï¸ ${holidayName}`; holEl.style.display = 'inline-block'; } 
            else { holEl.style.display = 'none'; }

            const modeKey = determineCurrentMode();
            const modeConfig = MODE_INFO[modeKey];
            document.documentElement.style.setProperty('--current-accent', modeConfig.color);
            document.getElementById('modeBadge').textContent = modeConfig.name;

            const btnRest = document.getElementById('btnRest');
            if(appData.isRestMode) { btnRest.classList.add('active'); document.getElementById('restText').textContent="ä¼‘æ¯ä¸­"; }
            else { btnRest.classList.remove('active'); document.getElementById('restText').textContent="ä¼‘æ¯"; }

            // ç·Šæ€¥ã‚¿ã‚¹ã‚¯
            const emergContainer = document.getElementById('emergencyDisplay');
            const emergListEl = document.getElementById('emergencyListDisplay');
            if(appData.emergencyList && appData.emergencyList.length > 0) {
                emergContainer.style.display = 'block';
                emergListEl.innerHTML = '';
                appData.emergencyList.forEach((item, index) => {
                    const li = document.createElement('li'); 
                    li.className = 'emergency-item-display';
                    li.innerHTML = `<button class="btn-emerg-check" onclick="completeEmergency(${index})">âœ”</button><span>${item}</span>`;
                    emergListEl.appendChild(li);
                });
            } else { emergContainer.style.display = 'none'; }

            // æ™‚é–“æŒ‡å®šã‚¿ã‚¹ã‚¯ (ãƒãƒŠãƒ¼è¡¨ç¤º)
            const interruptContainer = document.getElementById('interruptTaskDisplay');
            const activeInterrupt = appData.tasks.find(t => {
                if(!t.date || t.date !== todayKey || t.done || !t.startTime || !t.duration) return false;
                const startM = getMinutes(t.startTime);
                const endM = startM + parseInt(t.duration);
                return curM >= startM && curM < endM;
            });

            if(activeInterrupt) {
                currentInterruptTaskId = activeInterrupt.id;
                interruptContainer.style.display = 'flex';
                document.getElementById('interruptTaskTitle').textContent = activeInterrupt.text;
                const endM = getMinutes(activeInterrupt.startTime) + parseInt(activeInterrupt.duration);
                const endH = Math.floor(endM/60); const endMin = endM%60;
                document.getElementById('interruptTaskTime').textContent = 
                    `${activeInterrupt.startTime} - ${String(endH).padStart(2,'0')}:${String(endMin).padStart(2,'0')}`;
            } else {
                currentInterruptTaskId = null;
                interruptContainer.style.display = 'none';
            }

            // ã‚¤ãƒ™ãƒ³ãƒˆé€šçŸ¥ (FIXED_EVENTS + customEvents)
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const allEvents = [...FIXED_EVENTS, ...appData.customEvents];
            let msg = ""; let showMsg = false;
            
            allEvents.forEach(e => {
                let td = e.date.startsWith("*-") ? new Date(today.getFullYear(), parseInt(e.date.split("-")[1])-1, parseInt(e.date.split("-")[2])) : new Date(e.date);
                if(e.date.startsWith("*-") && td < today) td.setFullYear(today.getFullYear()+1);
                const diff = Math.ceil((td - today) / (1000 * 60 * 60 * 24));
                if(diff === 0) { msg = `ğŸ‰ ä»Šæ—¥ã¯ã€Œ${e.name}ã€`; showMsg=true; }
                else if(diff > 0 && diff <= 3) { msg = `ğŸ”” ${e.name}ã¾ã§ã‚ã¨${diff}æ—¥`; showMsg=true; }
            });
            const notifEl = document.getElementById('eventNotification');
            notifEl.textContent = msg; notifEl.style.display = showMsg ? 'block' : 'none';

            // ãƒ¡ãƒ¢
            const todayEvent = appData.calendarEvents[todayKey];
            const memoEl = document.getElementById('todayMemoDisplay');
            if (todayEvent && todayEvent.memo) { memoEl.textContent = `ğŸ“ ${todayEvent.memo}`; memoEl.style.display = 'inline-block'; }
            else { memoEl.style.display = 'none'; }

            // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¨ˆç®—
            if (!appData.schedules[modeKey]) return; // å®‰å…¨ç­–
            const schedule = appData.schedules[modeKey];
            schedule.sort((a,b) => {
                const sa = getMinutes(a.start); const sb = getMinutes(b.start);
                if(sa !== sb) return sa - sb;
                return getMinutes(a.end) - getMinutes(b.end);
            });
            
            // å¼·åˆ¶å°±å¯ãƒ­ã‚¸ãƒƒã‚¯ (21:30 ã€œ 05:00)
            const nightStart = getMinutes("21:30");
            const morningStart = getMinutes("05:00");
            const isNightMode = (curM >= nightStart) || (curM < morningStart);

            if (isNightMode) {
                 // å¤œé–“ãƒ¢ãƒ¼ãƒ‰ï¼ˆå°±å¯ä¸­ï¼‰
                 let diffM = 0;
                 if (curM >= nightStart) { 
                     diffM = (24 * 60 - curM) + morningStart;
                 } else { 
                     diffM = morningStart - curM;
                 }

                 const h = Math.floor(diffM / 60);
                 const m = diffM % 60;
                 
                 document.getElementById('actionDisplay').textContent = "å°±å¯ (ç¡çœ )";
                 document.getElementById('progressBar').style.width = '100%'; 
                 document.getElementById('timeRemaining').textContent = `èµ·åºŠã¾ã§ ${h}æ™‚é–“${m}åˆ†`;
                 
                 // æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯å¿…ãšç¿Œæ—¥æœ€åˆã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
                 const nextDayFirst = schedule.find(t => getMinutes(t.start) === morningStart) || schedule[0];
                 document.getElementById('nextTime').textContent = nextDayFirst.start;
                 document.getElementById('nextActionDisplay').textContent = nextDayFirst.name;

            } else {
                // é€šå¸¸æ—¥ä¸­ãƒ¢ãƒ¼ãƒ‰
                let curTask = null, nextTask = null;
                const runningTasks = schedule.filter(t => {
                    const s = getMinutes(t.start); const e = getMinutes(t.end);
                    return curM >= s && curM < e;
                });
                
                if(runningTasks.length > 0) {
                    runningTasks.sort((a,b) => getMinutes(a.end) - getMinutes(b.end));
                    curTask = runningTasks[0];
                    
                    const currentEnd = getMinutes(curTask.end);
                    let candidate = schedule.find(t => getMinutes(t.start) === currentEnd);
                    if (!candidate && runningTasks.length > 1) { candidate = runningTasks[1]; }
                    if (!candidate) { candidate = schedule.find(t => getMinutes(t.start) >= currentEnd); }
                    nextTask = candidate || schedule[0];
                } else {
                    nextTask = schedule.find(t => getMinutes(t.start) > curM) || schedule[0];
                }

                if(curTask) {
                    document.getElementById('actionDisplay').textContent = curTask.name;
                    const total = getMinutes(curTask.end) - getMinutes(curTask.start);
                    const elap = curM - getMinutes(curTask.start);
                    document.getElementById('progressBar').style.width = `${total > 0 ? (elap/total)*100 : 100}%`;
                    document.getElementById('timeRemaining').textContent = `æ®‹ã‚Š ${getMinutes(curTask.end) - curM}åˆ†`;
                    
                    if(nextTask) {
                        let displayNextTime = nextTask.start;
                        // è¦ªã‚¿ã‚¹ã‚¯å¾©å¸°æ™‚ã®æ™‚é–“è£œæ­£
                        if (getMinutes(nextTask.start) < getMinutes(curTask.end) && getMinutes(nextTask.end) > getMinutes(curTask.end)) {
                            displayNextTime = curTask.end;
                        }
                        document.getElementById('nextTime').textContent = displayNextTime;
                        document.getElementById('nextActionDisplay').textContent = nextTask.name;
                    }
                } else {
                    document.getElementById('actionDisplay').textContent = "å¾…æ©Ÿä¸­";
                    document.getElementById('progressBar').style.width = '0%';
                    if(nextTask) {
                        document.getElementById('nextTime').textContent = nextTask.start;
                        document.getElementById('nextActionDisplay').textContent = nextTask.name;
                    }
                }
            }
        }

        // --- ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ãƒ‘ãƒãƒ« ---
        function updateDailyTaskPanel(todayKey) {
            const tasks = appData.tasks.filter(t => t.date === todayKey);
            const undoneCount = tasks.filter(t => !t.done).length;
            document.getElementById('dailyTaskCount').textContent = undoneCount;
            
            const listEl = document.getElementById('dailyTaskListInner');
            listEl.innerHTML = '';
            
            tasks.sort((a,b) => {
                if(a.startTime && b.startTime) return getMinutes(a.startTime) - getMinutes(b.startTime);
                if(a.startTime) return -1;
                if(b.startTime) return 1;
                return a.id - b.id;
            });

            tasks.forEach(t => {
                const row = document.createElement('div');
                row.className = `daily-task-row ${t.done ? 'done' : ''}`;
                let timeStr = "";
                if(t.startTime) timeStr = `<span class="daily-task-time">[${t.startTime}]</span>`;
                row.innerHTML = `<div class="check-circle" onclick="toggleTask('${t.id}')"></div><div class="daily-task-text">${timeStr}${t.text}</div>`;
                listEl.appendChild(row);
            });
        }

        function toggleDailyTaskPanel() {
            const wrapper = document.getElementById('dailyTaskListWrapper');
            const btn = document.querySelector('.daily-task-btn');
            if(wrapper.classList.contains('open')) { wrapper.classList.remove('open'); btn.classList.remove('active'); } 
            else { wrapper.classList.add('open'); btn.classList.add('active'); }
        }

        // --- ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ ---
        function toggleOvertimeMode() { appData.isOvertimeMode = !appData.isOvertimeMode; saveData(); updateDisplay(); }
        function toggleRestMode() { appData.isRestMode = !appData.isRestMode; saveData(); updateDisplay(); }

        // --- ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒ»ã‚¹ãƒ­ãƒƒãƒˆæ©Ÿèƒ½ ---
        function openTaskManager() {
            setInputDate('today');
            renderTaskList();
            renderEmergencyEdit();
            document.getElementById('taskModal').classList.add('open');
        }
        function closeTaskManager() { document.getElementById('taskModal').classList.remove('open'); updateDisplay(); }

        function renderEmergencyEdit() {
            const list = document.getElementById('emergencyEditList');
            list.innerHTML = '';
            appData.emergencyList.forEach((item, index) => {
                const div = document.createElement('div'); div.className = 'emergency-item-edit';
                div.innerHTML = `<input type="text" value="${item}" class="emergency-input" onchange="updateEmergency(${index}, this.value)" style="text-align:left;"><button class="btn-delete" onclick="deleteEmergency(${index})">Ã—</button>`;
                list.appendChild(div);
            });
        }
        function addEmergency() {
            const val = document.getElementById('newEmergencyInput').value;
            if(val) { appData.emergencyList.push(val); document.getElementById('newEmergencyInput').value=''; saveData(); renderEmergencyEdit(); updateDisplay(); }
        }
        function updateEmergency(idx, val) { appData.emergencyList[idx] = val; saveData(); updateDisplay(); }
        function deleteEmergency(idx) { appData.emergencyList.splice(idx, 1); saveData(); renderEmergencyEdit(); updateDisplay(); }
        function completeEmergency(idx) {
            if(confirm('ç·Šæ€¥ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†(å‰Šé™¤)ã—ã¾ã™ã‹ï¼Ÿ')) {
                appData.emergencyList.splice(idx, 1);
                saveData();
                updateDisplay();
                if(document.getElementById('taskModal').classList.contains('open')) renderEmergencyEdit();
            }
        }

        function renderTaskList() {
            const list = document.getElementById('taskList'); list.innerHTML = '';
            const completedList = document.getElementById('completedList'); completedList.innerHTML = '';
            const undone = appData.tasks.filter(t => !t.done);
            const done = appData.tasks.filter(t => t.done);
            const unscheduled = undone.filter(t => !t.date);
            const scheduled = undone.filter(t => t.date);
            
            unscheduled.sort((a,b) => getPrioVal(b.prio) - getPrioVal(a.prio));
            scheduled.sort((a,b) => {
                const da = new Date(a.date); const db = new Date(b.date);
                if(da.getTime() !== db.getTime()) return da - db;
                if(a.startTime && b.startTime) return getMinutes(a.startTime) - getMinutes(b.startTime);
                return 0;
            });
            done.sort((a,b) => b.id - a.id);

            if(unscheduled.length > 0) {
                const label = document.createElement('div'); label.style.color = '#888'; label.style.fontSize = '0.8rem'; label.style.margin = '10px 0 5px';
                label.textContent = "ãƒ—ãƒ¼ãƒ«ï¼ˆå„ªå…ˆåº¦é †ï¼‰"; list.appendChild(label);
                unscheduled.forEach(t => list.appendChild(createTaskEl(t)));
            }
            if(scheduled.length > 0) {
                const label = document.createElement('div'); label.style.color = '#888'; label.style.fontSize = '0.8rem'; label.style.margin = '10px 0 5px';
                label.textContent = "ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ¸ˆã¿"; list.appendChild(label);
                scheduled.forEach(t => list.appendChild(createTaskEl(t)));
            }
            document.getElementById('completedCount').textContent = done.length;
            done.forEach(t => completedList.appendChild(createTaskEl(t)));
            const cl = document.getElementById('completedList');
            if(appData.showCompleted) cl.classList.add('show'); else cl.classList.remove('show');
        }

        function getPrioVal(p) { return p==='high'?3 : p==='mid'?2 : 1; }

        function createTaskEl(t) {
            const el = document.createElement('div');
            el.className = `task-item prio-${t.prio} ${t.done?'done':''}`;
            let timeInfo = "";
            if(t.date && t.startTime && t.duration) {
                timeInfo = `<span style="color:${getComputedStyle(document.documentElement).getPropertyValue('--accent-weekend').trim()}; margin-right:5px;">âš¡ ${t.startTime} (${t.duration}åˆ†)</span>`;
            }

            el.innerHTML = `
                <button class="btn-check ${t.done?'checked':''}" onclick="toggleTask('${t.id}')">âœ”</button>
                <div class="task-content">
                    <div class="task-text">${t.text}</div>
                    <div class="task-meta">
                        ${timeInfo}
                        <input type="date" value="${t.date || ''}" onchange="updateTaskDate('${t.id}', this.value)" class="task-date-input">
                        ${!t.done ? `
                        <div class="prio-select-wrapper">
                            <select class="prio-select ${t.prio}" onchange="changePrio('${t.id}', this.value)">
                                <option value="high" ${t.prio==='high'?'selected':''}>é«˜</option>
                                <option value="mid" ${t.prio==='mid'?'selected':''}>ä¸­</option>
                                <option value="low" ${t.prio==='low'?'selected':''}>ä½</option>
                            </select>
                        </div>
                        ` : ''}
                    </div>
                </div>
                <button class="btn-delete" onclick="deleteTask('${t.id}')">Ã—</button>
            `;
            return el;
        }

        function changePrio(id, newPrio) { const t = appData.tasks.find(x => x.id === id); if(t) { t.prio = newPrio; saveData(); renderTaskList(); } }
        function updateTaskDate(id, newDate) { const t = appData.tasks.find(x => x.id === id); if(t) { t.date = newDate; saveData(); renderTaskList(); } }

        function addTask() {
            const text = document.getElementById('newTaskName').value;
            const date = document.getElementById('newTaskDate').value;
            const prio = document.getElementById('newTaskPrio').value;
            const slotVal = document.getElementById('taskSlotSelect').value;
            
            let start = document.getElementById('newTaskStartTime').value; 
            let dur = document.getElementById('newTaskDuration').value;

            // ã‚¹ãƒ­ãƒƒãƒˆé¸æŠãŒå„ªå…ˆ
            if(slotVal) {
                const [s, d] = slotVal.split('|');
                start = s; dur = d;
            }
            
            if(!text) return;
            
            const id = Date.now().toString();
            appData.tasks.push({ id, text, date, prio, done: false, startTime: start, duration: dur });
            document.getElementById('newTaskName').value = '';
            document.getElementById('taskSlotSelect').value = ''; 
            document.getElementById('bookingWarning').style.display = 'none';
            saveData(); renderTaskList();
        }

        function initTimeOptions() {
            const sel = document.getElementById('newTaskStartTime');
            sel.innerHTML = '<option value="">é–‹å§‹æ™‚é–“(ä»»æ„)</option>';
            for(let h=5; h<=23; h++) {
                for(let m=0; m<60; m+=15) {
                    const val = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
                    const opt = document.createElement('option');
                    opt.value = val; opt.text = val;
                    sel.appendChild(opt);
                }
            }
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆæœˆæ—¥é¸æŠè‚¢ã®ç”Ÿæˆ
        function initEventSelects() {
            const mSel = document.getElementById('newEventMonth');
            const dSel = document.getElementById('newEventDay');
            mSel.innerHTML = ''; dSel.innerHTML = '';
            for(let i=1; i<=12; i++) { const opt = document.createElement('option'); opt.value = String(i).padStart(2,'0'); opt.text = i; mSel.appendChild(opt); }
            for(let i=1; i<=31; i++) { const opt = document.createElement('option'); opt.value = String(i).padStart(2,'0'); opt.text = i; dSel.appendChild(opt); }
        }
        
        // ã‚¹ãƒ­ãƒƒãƒˆé‡è¤‡ãƒã‚§ãƒƒã‚¯
        function checkBooking() {
            const date = document.getElementById('newTaskDate').value;
            const slotVal = document.getElementById('taskSlotSelect').value;
            const warning = document.getElementById('bookingWarning');
            if(warning) warning.style.display = 'none'; 
            
            if(!date || !slotVal) return;
            
            const [start, dur] = slotVal.split('|');
            
            const conflict = appData.tasks.some(t => {
                return t.date === date && !t.done && t.startTime === start; 
            });
            
            if(conflict && warning) {
                warning.style.display = 'block';
            }
        }

        function setInputDate(type) {
            const el = document.getElementById('newTaskDate');
            if(type === 'today') el.value = getYYYYMMDD(new Date());
            else if(type === 'tomorrow') { const d = new Date(); d.setDate(d.getDate()+1); el.value = getYYYYMMDD(d); }
            else { el.value = ''; }
            checkBooking();
        }

        function toggleTask(id) { const t = appData.tasks.find(x => x.id === id); if(t) t.done = !t.done; saveData(); renderTaskList(); }
        function deleteTask(id) { if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { appData.tasks = appData.tasks.filter(x => x.id !== id); saveData(); renderTaskList(); } }
        function toggleCompletedList() { appData.showCompleted = !appData.showCompleted; saveData(); renderTaskList(); }
        function completeInterruptTask() { if(currentInterruptTaskId) toggleTask(currentInterruptTaskId); }

        // --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ---
        function openCalendar() { renderCalendar(); document.getElementById('calModal').classList.add('open'); }
        function closeCalendar() { document.getElementById('calModal').classList.remove('open'); updateDisplay(); }
        function changeMonth(delta) { viewingMonth.setMonth(viewingMonth.getMonth()+delta); renderCalendar(); }
        
        function renderCalendar() {
            const y = viewingMonth.getFullYear(); const m = viewingMonth.getMonth();
            document.getElementById('calMonthLabel').textContent = `${y}å¹´ ${m+1}æœˆ`;
            const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
            ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(d => { const h=document.createElement('div'); h.className='cal-header'; h.textContent=d; grid.appendChild(h); });
            for(let i=0; i<new Date(y,m,1).getDay(); i++) grid.appendChild(document.createElement('div'));
            const lastDate = new Date(y,m+1,0).getDate(); const todayStr = getYYYYMMDD(new Date());

            for(let d=1; d<=lastDate; d++) {
                const date = new Date(y,m,d); const dKey = getYYYYMMDD(date);
                const cell = document.createElement('div'); cell.className = 'cal-day'; cell.textContent = d;
                if(dKey===todayStr) cell.classList.add('today');
                
                const evt = checkEventStatus(date);
                if(evt) { if(evt.type==='holiday') cell.classList.add('is-holiday'); if(evt.type==='event') cell.classList.add('is-event'); }
                
                const tasks = appData.tasks.filter(t => t.date === dKey && !t.done);
                tasks.forEach(t => {
                    const bar = document.createElement('div'); bar.className = `cal-task-bar ${t.prio}`; cell.appendChild(bar);
                });
                if(appData.calendarEvents[dKey] && appData.calendarEvents[dKey].memo) cell.classList.add('has-note');
                cell.innerHTML += `<div class="cal-note-dot"></div>`;
                cell.onclick = () => openDayConfig(dKey);
                grid.appendChild(cell);
            }
        }

        // æ—¥åˆ¥è¨­å®š
        function openDayConfig(dateKey) {
            configuringDateKey = dateKey;
            
            const date = new Date(dateKey); const evt = checkEventStatus(date);
            const infoEl = document.getElementById('dayHolidayInfo');
            if(evt) { infoEl.textContent = evt.type==='holiday' ? `ãŠ—ï¸ ${evt.name}` : `ğŸ‰ ${evt.name}`; infoEl.style.display='block'; }
            else { infoEl.style.display='none'; }
            document.getElementById('dayConfigTitle').textContent = `${dateKey} è¨­å®š`;
            
            const taskSection = document.getElementById('dayTaskSection');
            const taskListEl = document.getElementById('dayTaskList');
            const tasks = appData.tasks.filter(t => t.date === dateKey);
            taskListEl.innerHTML = '';
            if(tasks.length > 0) {
                taskSection.style.display = 'block';
                tasks.sort((a,b) => (a.done === b.done) ? getPrioVal(b.prio) - getPrioVal(a.prio) : a.done ? 1 : -1);
                tasks.forEach(t => {
                    const div = document.createElement('div'); div.className = `day-task-item ${t.prio} ${t.done ? 'done' : ''}`;
                    let time = ""; if(t.startTime) time = `[${t.startTime}] `;
                    div.innerHTML = `<span>${time}${t.text}</span><span>${t.done ? 'æ¸ˆ' : 'æœª'}</span>`;
                    taskListEl.appendChild(div);
                });
            } else { taskSection.style.display = 'none'; }

            const conf = appData.calendarEvents[dateKey] || {memo:'', mode:''};
            document.getElementById('dayMemoInput').value = conf.memo||'';
            document.getElementById('dayModeSelect').value = conf.mode||'';
            document.getElementById('dayConfigModal').classList.add('open');
        }
        function closeDayConfig() { document.getElementById('dayConfigModal').classList.remove('open'); }
        function saveDayConfig() {
            const memo = document.getElementById('dayMemoInput').value;
            const mode = document.getElementById('dayModeSelect').value;
            if(!memo && !mode) delete appData.calendarEvents[configuringDateKey];
            else appData.calendarEvents[configuringDateKey] = {memo, mode};
            saveData(); closeDayConfig(); renderCalendar(); updateDisplay();
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†ï¼ˆãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ï¼‰
        function openEventManager() { renderEventList(); document.getElementById('eventModal').classList.add('open'); }
        function closeEventManager() { document.getElementById('eventModal').classList.remove('open'); updateDisplay(); }
        function renderEventList() {
            const list = document.getElementById('eventList'); list.innerHTML = '';
            
            // ä¿®æ­£: å›ºå®šã‚¤ãƒ™ãƒ³ãƒˆã¯ãƒªã‚¹ãƒˆè¡¨ç¤ºã—ãªã„ã€‚ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿è¡¨ç¤ºã€‚
            let displayEvents = appData.customEvents.map((evt, idx) => ({...evt, originalIndex: idx}));
            
            if (displayEvents.length === 0) {
                list.innerHTML = '<div style="color:#888; font-size:0.8rem; text-align:center; padding:15px;">ç™»éŒ²ã•ã‚ŒãŸè¨˜å¿µæ—¥ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            // æ—¥ä»˜é †ã‚½ãƒ¼ãƒˆ (MM-DD)
            displayEvents.sort((a,b) => {
                const [m1, d1] = a.date.replace('*-','').split('-').map(Number);
                const [m2, d2] = b.date.replace('*-','').split('-').map(Number);
                if(m1 !== m2) return m1 - m2;
                return d1 - d2;
            });

            displayEvents.forEach(evt => {
                const row = document.createElement('div');
                row.className = 'list-item event-item-custom';
                row.innerHTML = `<span>${evt.date}</span><span>${evt.name}</span><button class="btn-delete" onclick="deleteCustomEvent(${evt.originalIndex})">Ã—</button>`;
                list.appendChild(row);
            });
        }
        
        function addCustomEvent() {
            const m = document.getElementById('newEventMonth').value;
            const d = document.getElementById('newEventDay').value;
            const name = document.getElementById('newEventName').value;
            if(name && m && d) {
                const dateStr = `*-${m}-${d}`;
                appData.customEvents.push({ date: dateStr, name: name, type: 'event' });
                document.getElementById('newEventName').value = '';
                saveData(); renderEventList();
            }
        }
        function deleteCustomEvent(idx) {
            if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                appData.customEvents.splice(idx, 1);
                saveData(); renderEventList();
            }
        }
        
        function openConfig() { switchEditorTab(determineCurrentMode()); document.getElementById('configModal').classList.add('open'); }
        function closeConfig() { document.getElementById('configModal').classList.remove('open'); }
        function switchEditorTab(modeKey) {
            editingModeKey = modeKey;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab_${modeKey}`).classList.add('active');
            const list = document.getElementById('scheduleList'); list.innerHTML = '';
            appData.schedules[modeKey].sort((a,b)=>getMinutes(a.start)-getMinutes(b.start)).forEach(item => {
                const row = document.createElement('div'); row.className = 'list-item schedule-item';
                row.innerHTML = `<input type="text" value="${item.start}" class="inp-start"><input type="text" value="${item.end}" class="inp-end"><input type="text" value="${item.name}" class="inp-name"><button class="btn-delete" onclick="this.parentElement.remove()">âœ•</button>`;
                list.appendChild(row);
            });
        }
        function addScheduleRow() {
            const list = document.getElementById('scheduleList');
            const row = document.createElement('div'); row.className = 'list-item schedule-item';
            row.innerHTML = `<input type="text" value="00:00" class="inp-start"><input type="text" value="00:00" class="inp-end"><input type="text" value="æ–°è¦" class="inp-name"><button class="btn-delete" onclick="this.parentElement.remove()">âœ•</button>`;
            list.appendChild(row);
        }
        function saveConfig() {
            const list = document.getElementById('scheduleList'); const newSched = [];
            Array.from(list.children).forEach(row => {
                const s=row.querySelector('.inp-start').value; const e=row.querySelector('.inp-end').value; const n=row.querySelector('.inp-name').value;
                if(s&&e) newSched.push({start:s,end:e,name:n});
            });
            appData.schedules[editingModeKey] = newSched; saveData(); closeConfig(); updateDisplay();
        }

        // --- åˆæœŸåŒ– ---
        loadData();
        setInterval(updateDisplay, 1000);
        updateDisplay();
    </script>
</body>
</html>
